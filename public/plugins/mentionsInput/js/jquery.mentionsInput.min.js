
(function(f,d,g){var b={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35};var e={triggerChar:"@",onDataRequest:f.noop,minChars:1,allowRepeat:false,showAvatars:false,elastic:true,defaultValue:"",onCaret:true,classes:{autoCompleteItemActive:"active"},templates:{wrapper:d.template('<div class="mentions-input-box"></div>'),autocompleteList:d.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:d.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:d.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:d.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:d.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:d.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:d.template("<strong><span><%= value %></span></strong>")}};var a={htmlEncode:function(h){return d.escape(h)},regexpEncode:function(h){return h.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(i,h){if(!h&&!h.length){return i}return i.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+h+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")},setCaratPosition:function(j,i){if(j.createTextRange){var h=j.createTextRange();h.move("character",i);h.select()}else{if(j.selectionStart){j.focus();j.setSelectionRange(i,i)}else{j.focus()}}},rtrim:function(h){return h.replace(/\s+$/,"")}};var c=function(I){var q,p,z,w,F,y,L,K=[],G={},C=[],O="";I=f.extend(true,{},e,I);function v(){p=f(q);if(p.attr("data-mentions-input")==="true"){return}z=p.parent();F=f(I.templates.wrapper());p.wrapAll(F);F=z.find("> div.mentions-input-box");p.attr("data-mentions-input","true");p.bind("keydown",r);p.bind("keypress",u);p.bind("click",m);p.bind("blur",s);if(navigator.userAgent.indexOf("MSIE 8")>-1){p.bind("propertychange",N)}else{p.bind("input",N)}if(I.elastic){p.elastic()}}function M(){w=f(I.templates.autocompleteList());w.appendTo(F);w.delegate("li","mousedown",t)}function P(){y=f(I.templates.mentionsOverlay());y.prependTo(F)}function x(){var R=j();d.each(K,function(T){var S=I.templates.mentionItemSyntax(T);R=R.replace(new RegExp(a.regexpEncode(T.value),"g"),S)});var Q=a.htmlEncode(R);d.each(K,function(U){var T=d.extend({},U,{value:a.htmlEncode(U.value)});var S=I.templates.mentionItemSyntax(T);var V=I.templates.mentionItemHighlight(T);Q=Q.replace(new RegExp(a.regexpEncode(S),"g"),V)});Q=Q.replace(/\n/g,"<br />");Q=Q.replace(/ {2}/g,"&nbsp; ");p.data("messageText",R);p.trigger("updated");y.find("div").html(Q)}function k(){C=[]}function D(){var Q=j();K=d.reject(K,function(S,R){return !S.value||Q.indexOf(S.value)==-1});K=d.compact(K)}function E(Z){var Q=j(),X=p[0].selectionStart,ac=false,R=false;var aa=new RegExp("\\"+I.triggerChar+O,"gi"),ab;while(ab=aa.exec(Q)){if(ac===false||Math.abs(aa.lastIndex-X)<ac){ac=Math.abs(aa.lastIndex-X);R=aa.lastIndex}}var Y=R-O.length-1;var T=R;var S=Q.substr(0,Y);var U=Q.substr(T,Q.length);var V=(S+Z.value).length+1;if(!d.find(K,function(ad){return ad.id==Z.id})){K.push(Z)}k();O="";B();var W=S+Z.value+" "+U;p.val(W);p.trigger("mention");x();p.focus();a.setCaratPosition(p[0],V)}function j(){return f.trim(p.val())}function J(ab){var aa,Z,Y,X,W,V,U,T,S,R,Q;if(!(S=ab[0])){return}if(!f(S).is("textarea")){return}if(S.selectionEnd==null){return}U={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},T=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"];for(R=0,Q=T.length;R<Q;R++){W=T[R],U[W]=f(S).css(W)}return Y=document.createElement("div"),f(Y).css(U),f(S).after(Y),Z=document.createTextNode(S.value.substring(0,S.selectionEnd)),aa=document.createTextNode(S.value.substring(S.selectionEnd)),X=document.createElement("span"),X.innerHTML="&nbsp;",Y.appendChild(Z),Y.appendChild(X),Y.appendChild(aa),Y.scrollTop=S.scrollTop,V=f(X).position(),f(Y).remove(),V}function n(ab){var aa,Z,Y,X,W,V,U,T,S,R,Q;if(!(S=ab[0])){return}if(!f(S).is("textarea")){return}if(S.selectionEnd==null){return}U={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},T=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"];for(R=0,Q=T.length;R<Q;R++){W=T[R],U[W]=f(S).css(W)}return Y=document.createElement("div"),f(Y).css(U),f(S).after(Y),Z=document.createTextNode(S.value.substring(0,S.selectionEnd)),aa=document.createTextNode(S.value.substring(S.selectionEnd)),X=document.createElement("span"),X.innerHTML="&nbsp;",Y.appendChild(Z),Y.appendChild(X),Y.appendChild(aa),Y.scrollTop=S.scrollTop,V=f(X).offset(),f(Y).remove(),V}function i(){var Q=f(p).offset().top;var S=f("body").offset().top;var R=f(window).scrollTop();if(R>Q){f(window).scrollTop(Q-S)}}function t(S){var R=f(this);var Q=G[R.attr("data-uid")];E(Q);i();return false}function m(Q){k()}function s(Q){B()}function N(R){x();D();var Q=d.lastIndexOf(C,I.triggerChar);if(Q>-1){O=C.slice(Q+1).join("");O=a.rtrim(O);d.defer(d.bind(A,this,O))}}function u(R){if(R.keyCode!==b.BACKSPACE){var Q=String.fromCharCode(R.which||R.keyCode);C.push(Q)}}function r(R){if(R.keyCode===b.LEFT||R.keyCode===b.RIGHT||R.keyCode===b.HOME||R.keyCode===b.END){d.defer(k);if(navigator.userAgent.indexOf("MSIE 9")>-1){d.defer(x)}return}if(R.keyCode===b.BACKSPACE){C=C.slice(0,-1+C.length);return}if(!w.is(":visible")){return true}switch(R.keyCode){case b.UP:case b.DOWN:var Q=null;if(R.keyCode===b.DOWN){if(L&&L.length){Q=L.next()}else{Q=w.find("li").first()}}else{Q=f(L).prev()}if(Q.length){h(Q)}return false;case b.RETURN:case b.TAB:if(L&&L.length){L.trigger("mousedown");return false}break}return true}function B(){L=null;w.empty().hide()}function h(Q){Q.addClass(I.classes.autoCompleteItemActive);Q.siblings().removeClass(I.classes.autoCompleteItemActive);L=Q}function H(T,S){w.show();if(!I.allowRepeat){var R=d.pluck(K,"value");S=d.reject(S,function(U){return d.include(R,U.name)})}if(!S.length){B();return}w.empty();var Q=f("<ul>").appendTo(w).hide();d.each(S,function(X,V){var Y=d.uniqueId("mention_");G[Y]=d.extend({},X,{value:X.name});var W=f(I.templates.autocompleteListItem({id:a.htmlEncode(X.id),display:a.htmlEncode(X.name),type:a.htmlEncode(X.type),content:a.highlightTerm(a.htmlEncode((X.display?X.display:X.name)),T)})).attr("data-uid",Y);if(V===0){h(W)}if(I.showAvatars){var U;if(X.avatar){U=f(I.templates.autocompleteListItemAvatar({avatar:X.avatar}))}else{U=f(I.templates.autocompleteListItemIcon({icon:X.icon}))}U.prependTo(W)}W=W.appendTo(Q)});w.show();if(I.onCaret){o(w,p)}Q.show()}function A(Q){if(Q&&Q.length&&Q.length>=I.minChars){I.onDataRequest.call(this,"search",Q,function(R){H(Q,R)})}else{B()}}function o(T,R){var U=T.css("position");if(U=="absolute"){var Q=J(R),V=parseInt(R.css("line-height"),10)||18;T.css("width","15em");T.css("left",Q.left);T.css("top",V+Q.top);var S=R.offset().left+R.width(),W=T.offset().left+T.width();if(S<=W){T.css("left",Math.abs(T.position().left-(W-S)))}}else{if(U=="fixed"){var X=n(R),V=parseInt(R.css("line-height"),10)||18;T.css("width","15em");T.css("left",X.left+10000);T.css("top",V+X.top)}}}function l(S){K=[];var T=a.htmlEncode(S);var U=new RegExp("("+I.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi");var R,Q=T;while((R=U.exec(T))!=null){Q=Q.replace(R[0],R[1]+R[2]);K.push({id:R[4],type:R[3],value:R[2],trigger:R[1]})}x()}return{init:function(Q){q=Q;v();M();P();l(I.defaultValue);if(I.prefillMention){E(I.prefillMention)}},val:function(Q){if(!d.isFunction(Q)){return}Q.call(this,K.length?p.data("messageText"):j())},reset:function(){l()},reinit:function(){l(false)},getMentions:function(Q){if(!d.isFunction(Q)){return}Q.call(this,K)}}};f.fn.mentionsInput=function(j,h){var i=arguments;if(typeof j==="object"||!j){h=j}return this.each(function(){var k=f.data(this,"mentionsInput")||f.data(this,"mentionsInput",new c(h));if(d.isFunction(k[j])){return k[j].apply(this,Array.prototype.slice.call(i,1))}else{if(typeof j==="object"||!j){return k.init.call(this,this)}else{f.error("Method "+j+" does not exist")}}})}})(jQuery,_);